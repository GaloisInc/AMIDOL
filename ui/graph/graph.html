<!doctype html>
<meta charset="utf-8">
<head>
	<script type="text/javascript" src="jquery-3.3.1.min.js"></script>
	<script type="text/javascript" src="vis-4.21.0.min.js"></script>
	<script type="text/javascript" src="underscore-1.9.1.min.js"></script>
	<link rel="stylesheet" href="vis-4.21.0.min.css" type="text/css" />

	<style type="text/css">
		html, body, #graph {
			padding: 0px;
			margin: 0px;
			height: 100%;
			width: 100%;
			overflow: hidden;
		}
		#palette img {
			margin: 5px;
			padding: 5px;
			height: 50px;
			border: 5px solid white;
		}
		#palette img.selected {
			border-color: lightblue;
		}
		#palette img.right {
			float: right;
			height: 25px;
		}
		#palette img.disabled {
			opacity: 0.25;
		}

	</style>

<script type="text/javascript">

	var node_data_set, edge_data_set, network;

	var journal = {
		past : [],
		future : [],

		// `apply`, `undo`, and `redo` manage the journals _and_ trigger effects through applyEventEffects
		apply: function(event) {
			this.past.push(event)
			this.future = []
			this.applyEventEffects(event)
		},

		undo : function() {
			if (this.past.length > 0) {
				var journal_event = this.past.pop()
				this.future.unshift(journal_event)
				this.applyEventEffects(this.invertEvent(journal_event))
			}
		},

		redo : function() {
			if (this.future.length > 0) {
				var journal_event = this.future.shift()
				this.past.push(journal_event)
				this.applyEventEffects(journal_event)
			}
		},



		// Purpose: cause UI side effects... and nothing else. 
		// Always call last, after setting the relevant shared states.
		applyEventEffects : function(event) {
			// event = { type: <<"add", "subtract">>, nodes: […], edges: […] }
			switch (event.type) {
				case "add":
					node_data_set.add(event.nodes)
					edge_data_set.add(event.edges)
					break
				case "subtract":
					var node_ids_to_remove = _.pluck(event.nodes, "id")
					var edge_ids_to_remove = _.pluck(event.edges, "id")
					node_data_set.remove(node_ids_to_remove)
					edge_data_set.remove(edge_ids_to_remove)
					break
				case "move":
	                _.mapObject(event.to, function(pos, nodeId){
	                    node_data_set.update({id: nodeId, x: pos.x, y: pos.y})
	                })
	                break
	            case "renameEdge":
	                edge_data_set.update({id: event.id, label: event.to})
	                break
	            case "renameNode":
	                node_data_set.update({id: event.id, label: event.to})
	                break
				default:
					break
			}
			UI.updateButtonStates()
		},

		invertEvent : function(initial_event) {
			var event = _.clone(initial_event)  // make a copy, return a new object
			switch (event.type) {
				case "add":
					event.type = "subtract"
					return event
				case "subtract":
					event.type = "add"
					return event
				case "move":
					var from = event.from
					event.from = event.to
					event.to = from
					return event
	            case "renameEdge":
	                var from = event.from
	                event.from = event.to
	                event.to = from
	                return event
	            case "renameNode":
	                var from = event.from
	                event.from = event.to
	                event.to = from
	                return event
				default:
					return event
			}
		},

		logHistory : function() {
			console.log(
				JSON.stringify(
					[ _.map(journal.past, function(x){return x.type + ":" + _.map(x.nodes, function(y){return y.id})}),
					  _.map(journal.future, function(x){return x.type + ":" + _.map(x.nodes, function(y){return y.id})}) ]
				)
			)
		}
	}


	var UI = {
	    renameEdge: function(edgeId, newName) {
	        var existing = edge_data_set.get(edgeId)
	        var event = {type: "renameEdge", id: edgeId, from: existing.label, to: newName}
	        journal.apply(event)
	    },

	    renameNode: function(nodeId, newName) {
	        var existing = node_data_set.get(nodeId)
	        var event = {type: "renameNode", id: nodeId, from: existing.label, to: newName}
	        journal.apply(event)
	    },
		
		updateButtonStates : function() {
			if (_.isEmpty(journal.past)) {
				$("#undo_button").addClass("disabled")
			} else {
				$("#undo_button").removeClass("disabled")
			}
			if (_.isEmpty(journal.future)) {
				$("#redo_button").addClass("disabled")
			} else {
				$("#redo_button").removeClass("disabled")
			}
		},

		selectPaletteNode : function(elem) {
			$("#palette img").removeClass("selected")
			$(elem).addClass("selected")
		},

		drawNetwork : function() {
			var data = { "nodes" : [], "edges" : [] }
			var options = {
				physics: false,
				nodes: {
					shape: "image"
				},
				edges: {
					smooth: false,
					color: { color: "black" },
					arrows: "to"
				},
				manipulation: {
					initiallyActive: true,
					addNode: function(node, callback){
						node.label = prompt("Name your new node:")
						if (node.label != null) {
							node.image = $("#palette img.selected").attr("src")
							journal.apply( { "type": "add", "nodes": [node], "edges": [] } )
						}
					},
					addEdge: function(edge, callback){
						edge.label = prompt("Edge label:")
						if (edge.label != null) {
							journal.apply( { "type": "add", "nodes": [], "edges": [edge] } )
						}
					},
					editNode: function(node, callback) {
						alert(JSON.stringify(node))
					},
					deleteNode: function(dataIds, callback) {
						journal.apply( { 
							"type": "subtract", 
							"nodes": node_data_set.get(dataIds.nodes), 
							"edges": edge_data_set.get(dataIds.edges)
						} )
					},
					deleteEdge: function(dataIds, callback) {
						journal.apply( { 
							"type": "subtract", 
							"nodes": node_data_set.get(dataIds.nodes), 
							"edges": edge_data_set.get(dataIds.edges) 
						} )
					}
				}
			}

			node_data_set = new vis.DataSet(data.nodes)
			edge_data_set = new vis.DataSet(data.edges)

			var container = document.getElementById('graph')
			var network_data = { "nodes" : node_data_set, "edges" : edge_data_set}
			network = new vis.Network(container, network_data, options)

			network.on("oncontext", UI.networkRightClick)
			network.on("doubleClick", function(e){
				// Renameing nodes and edges:
				if (_.size(e.nodes) == 1) {
					var newName = prompt("New node name:")
					if (newName !== null) {
						UI.renameNode(e.nodes[0], newName)
					}
				} else { if (_.size(e.edges) == 1) {
					var newName = prompt("New edge name:")
					if (newName !== null) {
						UI.renameEdge(e.edges[0], newName)
					}
				}}
			})
			network.on("oncontext", function(){})
			network.on("deselectNode", function(){})
			network.on("hold", function(){})
			network.on("dragStart", function(e){
				var selectedNodes = network.getSelectedNodes()
				if ( ! _.isEmpty(selectedNodes)) {
					UI.movingNodes = network.getPositions(selectedNodes)
				}
			})
			network.on("dragEnd", function(e){
				if (UI.movingNodes != null) {
					var from = UI.movingNodes
					var to = network.getPositions(_.keys(UI.movingNodes))
					UI.movingNodes = null
					journal.past.push({ "type" : "move", "from": from, "to": to })
				}
			})
			// $("#graph").on("mousemove", null)  // Cannot use network 'dragging' event?
		},

		networkRightClick : function(context) {
			console.log(context.event)
			context.event.preventDefault()
		},

		movingNodes : null // or:  { nodeId1: {x: xValue, y: yValue}, … }
	}


	var ELM = {
		getData : function(){
			return {
				"nodes" : node_data_set.getDataSet()._data,
				"edges" : edge_data_set.getDataSet()._data
			}
		}
	}



	$(function(){
		UI.drawNetwork()
		UI.updateButtonStates()

		var sample_nodes = [
			{id: 1, label: "Susceptible", image: "images/person.png", x: -250, y: 0}, 
			{id: 2, label: "Infected", title: "*cough*  *cough*", image: "images/sick.jpg", x: -0, y: 0}, 
			{id: 3, label: "Recovered", title: "I'm better!", image: "images/happy.png", x: 250, y: 0}
		]
		var sample_edges = [
			{id: "a", from: 1, to: 2, label: "gets sick"},
			{id: "b", from: 2, to: 3, label: "gets better"}
		]

		journal.apply( { "type": "add", "nodes": sample_nodes, "edges": sample_edges } )
	})
</script>
</head>
<body>
	<div id="palette">
		<img src="images/person.png" onclick="UI.selectPaletteNode(this)" />
		<img src="images/sick.jpg" onclick="UI.selectPaletteNode(this)" />
		<img src="images/happy.png" onclick="UI.selectPaletteNode(this)" />
		<img class="selected" src="images/virus.png" onclick="UI.selectPaletteNode(this)" />
		<img id="redo_button" class="right" src="images/redo.png" onclick="journal.redo()">
		<img id="undo_button" class="right" src="images/undo.png" onclick="journal.undo()">
	</div>
	<div id="graph"></div>
</body>