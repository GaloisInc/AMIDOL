<!doctype html>
<meta charset="utf-8">
	<script type="text/javascript" src="jquery.min.js"></script>
	<script type="text/javascript" src="underscore-min.js"></script>

	<link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

	<link rel="stylesheet" href="normalize.css">
	<link rel="stylesheet" href="skeleton.css">

	<script src="plotly.min.js"></script>

	<script type="text/javascript" src="trace.js"></script>
<script type="text/javascript">
	// This is the list of series we plan to plot
	var planned_data_series /* : [{ key: string, traces: [string] }] */ = [];

	// This is the list of valid data trace names
	var valid_data_traces /* : [string] */ = [];

	var UI = {

		// Upload a new data trace to the backend
		upload: function() {
			var fileInput = $("#data-trace-file")[0];
			var nameInput = $("#data-trace-name")[0];

			var file = fileInput.files[0];
			var name = nameInput.value;

			if (file && name) {
				var reader = new FileReader()
				reader.onload = function() {
					var data = JSON.parse(reader.result);
					var payload = {
						name: name,
						data: JSON.stringify(data.data),
						time: JSON.stringify(data.time)
					};
					$.post("/appstate/data-traces/put", payload, function (resp) {
						UI.renderPlotPlanningTable();
						nameInput.value = "";
						alert("Data source " + name + " has been uploaded");
					})
				};
				reader.readAsText(file);
			} else {
				alert("You need to enter a file and data trace name!");
			}
		},

		// Get from the backend the current list of valid data traces
		updatePossibleTraceNames: function(onComplete) {
			$.post("/appstate/data-traces/list", { limit: 100 }, function (resp) {
				valid_data_traces = resp;
				onComplete();
			})
		},

		// Redraw the table for planning out the plot
		renderPlotPlanningTable: function () {
			UI.updatePossibleTraceNames(function () {
				// Empty out the table
				$(".planned-series").remove();

				// Fill it back up
				var tableRows = _.map(planned_data_series, function(data_series, i) {

					// Build up the second cell: the one listing out the traces to sum
					data_trace_cell_lines = [];
					_.each(data_series.traces, function(trace, j) {
						data_trace_cell_lines.push(
							// The dropdown for which data trace to pick
							$("<select>").append(
								_.map(valid_data_traces, function(n) {
									var option = $("<option>").attr('value', n).html(n);
									if (trace == n) {
										option.attr('selected','selected');
									}
									return option
								})
							).on('change', function (e) {
								var valueSelected = this.value;
								planned_data_series[i].traces[j] = valueSelected;
							}),

							// The button for deleting this data trace
							$("<button>")
								.text("Remove trace")
								.click(function () {
									planned_data_series[i].traces.splice(j,1);
									UI.renderPlotPlanningTable();
								}),

							// A plus sign at the end of the line, and the line break
							" + ",
							$("<br>")
						);
					})

					// At the end of the list, have a `...` button for adding new terms
					data_trace_cell_lines.push(
						$("<button>")
							.text("...")
							.click(function() {
								UI.updatePossibleTraceNames(function () {
									if (valid_data_traces[0]) {
										planned_data_series[i].traces.push(valid_data_traces[0]);
										UI.renderPlotPlanningTable();
									} else {
										alert(
											"You cannot add a data trace to this series, since " +
											"there are no data traces to chose from!"
										);
									}
								});
							})
					);

					return $("<tr>").attr({ "class" : "planned-series"}).append([
						// Column for the name of the series
						$("<td>").append($("<input>")
							.attr("type", "text")
							.attr("value", data_series.key)
							.change(function(e) {
								planned_data_series[i].key = e.target.value;
								UI.renderPlotPlanningTable();
							})),
						// Column for the traces to add up
						$("<td>").append(data_trace_cell_lines),

						// Column for the button to delete the series
						$("<td>").append(
							$("<button>")
								.text("Delete series")
								.css({ clear: "both" })
								.click(function(e){
									planned_data_series.splice(i,1);
									UI.renderPlotPlanningTable();
								})
						)
					])
				});

				$("#plot-planning").append(tableRows);
			})
		},

		// Hide the plot results overlay
		closePlot: function() {
			$("#results").hide();
		},

		// Upload a new trace
		addTrace: function() {
			var traceName = prompt("Name your new trace:")
			if (traceName) {
				planned_data_series.push({ key: traceName, traces: [] });
				UI.renderPlotPlanningTable();
			}
		},

		// Plot the results
		plotResults: function() {
			// For each series, ask the backend for all the data of the constituent
			// data traces, then sum everything up.
			var posted_series = _.map(planned_data_series, function(data_trace) {
				var data = { names: JSON.stringify(data_trace.traces) };
				return $.post("/appstate/data-traces/get", data).then(function (resp) {
					var summed = _.reduce(
						_.map(resp, function(e) { return { x: e[1], y: e[2] } }),
						addTraces
					);
					summed = summed || { x: [], y: [] };
					summed.mode = 'lines+markers';
					summed.name = data_trace.key;
					return summed;
				})
			});

			// Sequence the results...
			$.when.apply($, posted_series).then(function() {
				var series = Array.prototype.slice.call(arguments);

				// Make the plot!
				var layout = {
					title: "Comparision"
				};
				var config = {
					toImageButtonOptions: {
						format: 'svg', // one of png, svg, jpeg, webp
						filename: 'comparision',
						height: 500,
						width: 700,
						scale: 1
					},
					responsive: true
				};
				$("#results").show();
				Plotly.newPlot("comparision-plot", series, layout, config);
			});
		}
	}

	// Start by rendering the table
	$(UI.renderPlotPlanningTable);

</script>

<style type="text/css">
	html, body {
		padding: 0px;
		margin: 0px;
		height: 100%;
		width: 100%;
		overflow: hidden;
	}
	h2 {
		font-size: 1.75em;
	}
	h3 {
		font-size: 1.5em;
	}
	h4 {
		font-size: 1.1em;
	}
	button {
		background-color: white;
	}

	#results {
		position: absolute;
		left: 40px;
		right: 40px;
		top: 80px;
		bottom: 80px;
		background-color: lightgray;
		border: 1px solid gray;
		border-radius: 15px;
		padding: 10px;
		z-index: 1;
	}
	#comparision-plot {
		position: absolute;
		top: 20px;
		bottom: 20px;
		left: 20px;
		right: 20px;
	}

</style>
<body>
	<div id="results" style="display: none;">
		<div id="comparision-plot"></div>
		<center>
			<button onclick="UI.closePlot()" style="position: absolute; bottom: 0">Close</button>
		</center>
	</div>
	<div style="padding: 1em">
		<h3>Models to compare</h3>
		<div style="padding: 1em">
			<table id='plot-planning' style="width:100%">
				<tr class="header">
					<th>Series name</th>
					<th>Data traces</th>
					<th></th>
				</tr>
			</table>
			<button id="add-series" onclick="UI.addTrace()">Add to comparision</button><br>
			<button id="plot-comparision" onclick="UI.plotResults()">Plot the comparision</button>
		</div>

		<h3>Upload a new data trace</h3>
		<div style="padding: 1em">
			Name: <input type="text" id="data-trace-name" name="trace-name" /><br>
			Data: <input type="file" id="data-trace-file" name="trace-file" /><br>
			<button onclick="UI.upload()">Upload trace</button>
		</div>
	</div>
</body>
