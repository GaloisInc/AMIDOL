<!doctype html>
<meta charset="utf-8">
<head>
	<script type="text/javascript" src="jquery-3.3.1.min.js"></script>
	<script type="text/javascript" src="vis-4.21.0.min.js"></script>
	<script type="text/javascript" src="underscore-1.9.1.min.js"></script>
	<link rel="stylesheet" href="vis-4.21.0.min.css" type="text/css" />

	<script type="text/javascript" src="jquery.fancybox.min.js"></script>
	<link rel="stylesheet" href="jquery.fancybox.min.css" type="text/css" />

	<link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

	<link rel="stylesheet" href="normalize.css">
	<link rel="stylesheet" href="skeleton.css">

	<link rel="stylesheet" href="chartist.min.css" type="text/css" />
	<script type="text/javascript" src="chartist.min.js"></script>
	<script type="text/javascript" src="chartist-plugin-axistitle.min.js"></script>
	


<script type="text/javascript">

	var node_data_set, edge_data_set, network;
	var global_vars = { Example : 0 };
	var reward_vars = []// { key: "Example", opt1: "Susceptible", opt2: "Instant of Time", range: { start: 0, end: 100, step: 5 }} ];
	var chosen_backend = "scipy"
 

	function get(o, p) { return p.reduce((xs, x) => (xs && xs[x]) ? xs[x] : null, o) }

	function getOrElse(value, alternate) {
		if (typeof value != "undefined" && value != null) {
			return value
		} else {
			return alternate
		}
	}

	$.postJSON = function(url, data, callback) {
		return jQuery.ajax({
			'type': 'POST',
			'url': url,
			'contentType': 'application/json',
			'data': JSON.stringify(data),
			'dataType': 'json',
			'success': callback
		});
	};

	

	var journal = {
		past : [],
		future : [],

		// `apply`, `undo`, and `redo` manage the journals _and_ trigger effects through applyEventEffects
		apply: function(event) {
			this.past.push(event)
			this.future = []
			this.applyEventEffects(event)
		},

		undo : function() {
			if (this.past.length > 0) {
				var journal_event = this.past.pop()
				this.future.unshift(journal_event)
				this.applyEventEffects(this.invertEvent(journal_event))
			}
		},

		redo : function() {
			if (this.future.length > 0) {
				var journal_event = this.future.shift()
				this.past.push(journal_event)
				this.applyEventEffects(journal_event)
			}
		},


		// Purpose: cause UI side effects... and nothing else. 
		// Always call last, after setting the relevant shared states.
		applyEventEffects : function(event) {
			switch (event.type) {
				case "add":
					node_data_set.add(event.nodes)
					edge_data_set.add(event.edges)
					break
				case "subtract":
					var node_ids_to_remove = _.pluck(event.nodes, "id")
					var edge_ids_to_remove = _.pluck(event.edges, "id")
					node_data_set.remove(node_ids_to_remove)
					edge_data_set.remove(edge_ids_to_remove)
					break
				case "move":
					_.mapObject(event.to, function(pos, nodeId){
						node_data_set.update({id: nodeId, x: pos.x, y: pos.y})
					})
					break
				case "renameEdge":
					edge_data_set.update({id: event.id, label: event.to})
					break
				case "renameNode":
					node_data_set.update({id: event.id, label: event.to})
					UI.render.localVars(event.id)
					break
				case "setProp":
					// { type: "setProp", id: 0, key: "", previous: "", updated: "" }
					var newParams = _.clone(get(node_data_set.get(event.id), ['props', 'parameters']))
					var newParamList = _.filter(newParams, (kv) => kv.name != event.key)
					if (event.updated !== null) {
						newParamList.push({ name: event.key, value: event.updated })
					}
					var newProps = _.clone(get(node_data_set.get(event.id), ['props']))
					newProps['parameters'] = newParamList
					node_data_set.update({ id: event.id, props: newProps })
					break
				case "setRewardVar":
					var new_rvs = _.filter(reward_vars, (v) => v.key != event.key)
					if (event.new != null) { new_rvs.push(event.new) }
					reward_vars = new_rvs
					UI.render.rewardVars()
					break
				default:
					console.log("Unknown event in applyEventEffects: " + JSON.stringify(event))
					break
			}
			UI.updateButtonStates()
		},

		invertEvent : function(initial_event) {
			var event = _.clone(initial_event)	// make a copy, return a new object
			switch (event.type) {
				case "add":
					event.type = "subtract"
					return event
				case "subtract":
					event.type = "add"
					return event
				case "move":
					var from = event.from
					event.from = event.to
					event.to = from
					return event
				case "renameEdge":
					var from = event.from
					event.from = event.to
					event.to = from
					return event
				case "renameNode":
					var from = event.from
					event.from = event.to
					event.to = from
					return event
				case "setProp":
					var previous = event.previous
					event.previous = event.updated
					event.updated = previous
					return event
				case "setRewardVar":
					var old = event.old
					event.old = event.new
					event.new = old
					return event
				default:
					console.log("Unknown event in invertEvent: " + JSON.stringify(event))
					return event
			}
		},

		logHistory : function() {
			console.log(
				JSON.stringify(
					[ _.map(journal.past, function(x){return x.type + ":" + _.map(x.nodes, function(y){return y.id})}),
						_.map(journal.future, function(x){return x.type + ":" + _.map(x.nodes, function(y){return y.id})}) ]
				)
			)
		}
	}

	var UI = {

		changeBackend: function(elem) {
			chosen_backend = $(elem).val()
		},

		render: {

			palette : function(palette) {
				$("#palette .paletteItem").remove()
				$("#palette").append(_.map(Object.values(palette), function(p){
					return $("<img />").attr({src: p.icon, classname: p.className}).attr("onclick", "UI.selectPaletteNode(this)").addClass("paletteItem").addClass(p.type)
				}))
				if ($(".selected").length == 0) { $(".paletteItem").first().addClass("selected") }
			},

			localVars : function(id) {
				var vs = $("#localVars")
				vs.empty()
				if (_.isNull(id)) {
					vs.append("<p>Select a node to display its variables</p><h2>Global Variables:</h2>")
					_.mapObject(global_vars, (v, k) => vs.append(
						$("<div><label>"+k+'</label><input value="'+v+'" onblur=""></input></div>')
					))
					vs.append($("<button>").html("<strike>New</strike>").click((e) => UI.addGlobalVar() ))
				} else {
					var thisNode = node_data_set.get(id)
					vs.append('<p onclick="network.selectNodes([]);UI.render.localVars(null)">‚áê back to global variables</p><h2>' + getOrElse(thisNode.label, "(no_name)") + "</h2>")
					var vars = getOrElse(get(thisNode, ['props', 'parameters']), [])
					vs.append(_.map(vars, function(v){
						return $("<div><label>"+v.name+'</label><input value="'+v.value+'" onblur="UI.propBlur({id: \''+id+'\'}, \''+v.name+'\', this.value)"></input></div>')
					}))
					vs.append($("<button>").html("<strike>New</strike>").click((e) => UI.addLocalVar() ))
				}
			},

			rewardVars : function() {
				var rvs = $("#rewardVars")
				rvs.empty()
				rvs.append("<h2>Reward Variables:</h2>")
				var nodeNames = _.filter(_.map(node_data_set.get(), function(n) {
					if (n.props.type == "noun") { return [n.id, n.label] } else { [] }
				}), (a) => ! _.isEmpty(a))
				var rv_names = ["Instant of Time", "Interval of Time", "Time Avg. Interval", "Steady State"]


				// reward_vars = _.map(reward_vars, function(r){
				// 	if ( ! _.isEmpty(nodeNames) && ! _.contains(nodeNames, r.opt1)) {
				// 		r.opt1 = nodeNames[0][1]
				// 	}
				// 	return r
				// }) 

				rvs.append(_.map(reward_vars, function(r){
					return $("<div>").attr({class: "rv_element", rv_key: r.key}).change(
						(e) => UI.updateRewardVar(r.key)
					).append([
						$("<h3>").attr({class: "key"}).html(r.key),
						$("<div>").append(
							$("<select>").attr({class: "opt1"}).append(
								_.map(nodeNames, function(n) { 
									var opt = $("<option>").attr('value', n[1]).html(n[1])
									if (r.opt1 == n[1]) {
										opt.attr('selected','selected') 
									}
									return opt
								})
							)
						),
						$("<h4>").html("Range"),
						$("<div>").append(
							$("<select>").attr({class: "opt2"}).append(
								_.map(rv_names, function(n, idx) { 
									var opt = $("<option>").attr({'value': n}).html(n)
									if (idx != 0) { opt.attr('disabled', 'disabled') }
									return opt
								})
							),
							$("<div>").append(
								$("<div>").attr({class: "range_param"}).append(
									$("<label>").html("Start"),
									$("<input>").attr({class: "range_start", value: r.range.start, 'size': 5})
								),
								$("<div>").attr({class: "range_param"}).append(
									$("<label>").html("Until"),
									$("<input>").attr({class: "range_end", value: r.range.end, 'size': 5})
								),
								$("<div>").attr({class: "range_param"}).append(
									$("<label>").html("Step"),
									$("<input>").attr({class: "range_step", value: r.range.step, 'size': 5})
								)
							)
						),
						$("<button>").html("Delete").css({clear: "both"}).click(function(e){
							UI.removeRewardVar(r.key)
						})
					])
				}))
				rvs.append($("<button>").html("New").click((e) => UI.addRewardVar() ))
			},

			fancyCharts : function(chartsData) {
				$.fancybox.destroy()
				var chartIdPrefix = "chart-"
				var charts = _.map(chartsData, function(i, idx) {
					return $("<div>").attr({id: chartIdPrefix + idx, class: "resultChart"})
				})
				$("#results").append(charts)
				$.fancybox.open(charts, {
					helpers : { 
						title : { type : 'inside' }
					},
					loop : true,
					afterClose: function() { $("#results").empty() },
					beforeShow: function() {
						// Creating the Chartist objects are in the `beforeShow` function because they were not rendering properly when fancybox changed slides. (all elements in the graph were rendered at a single point)
						_.map(chartsData, function(singleChartData, idx){
							var pluginOpts = {
								chartPadding: { top: 20, right: 0, bottom: 20, left: 0 },
								plugins: [ Chartist.plugins.ctAxisTitle({
									axisX: {
										axisTitle: singleChartData.title,
										axisClass: "ct-axis-title",
										offset: { x: 0, y: 40 },
										textAnchor: "middle"
									},
									axisY: {}
								})]
							}
							new Chartist.Line("#" + chartIdPrefix + idx, singleChartData, pluginOpts)
						})
					}
				})
			},

			network : function() {
				var data = { "nodes" : [], "edges" : [] }
				var options = {
					physics: false,
					nodes: {
						shape: "image"
					},
					edges: {
						smooth: false,
						color: { color: "black" },
						arrows: "to"
					},
					manipulation: {
						initiallyActive: true,
						addNode: function(node, callback){
							node.label = prompt("Name your new node:")
							var isUnused = _.find(node_data_set.get(), (n) => n.label == node.label) === undefined
							if (node.label != null && isUnused) {
								node.image = $("#palette img.selected").attr("src")
								var className = $("#palette img.selected").attr("classname")
								var node = UI.makeNode(node, className)
								journal.apply( { "type": "add", "nodes": [node], "edges": [] } )
							} else {
								if (! isUnused) { alert("That name is already used.") }
							}
						},
						addEdge: function(edge, callback){
							// edge.label = prompt("Edge label:")
							var fromType = get(node_data_set.get(edge.from), ['props', 'type'])
							var toType = get(node_data_set.get(edge.to), ['props', 'type'])
							if (fromType !== toType) {
								journal.apply( { "type": "add", "nodes": [], "edges": [edge] } )
							} else {
								alert("Cannot draw edges between two " + fromType + "s.")
							}
						},
						editEdge: false,
						// editNode: function(node, callback) {
						// 	var props = getOrElse(node.props, [])
						// 	UI.render.localVars(node.id, node.label, props)
						// 	callback() // returns the editing bar to its normal state
						// },
						deleteNode: function(dataIds, callback) {
							journal.apply( { 
								"type": "subtract", 
								"nodes": node_data_set.get(dataIds.nodes), 
								"edges": edge_data_set.get(dataIds.edges)
							} )
						},
						deleteEdge: function(dataIds, callback) {
							journal.apply( { 
								"type": "subtract", 
								"nodes": node_data_set.get(dataIds.nodes), 
								"edges": edge_data_set.get(dataIds.edges) 
							} )
						}
					}
				}

				node_data_set = new vis.DataSet(data.nodes)
				edge_data_set = new vis.DataSet(data.edges)

				var container = document.getElementById('graph')
				var network_data = { "nodes" : node_data_set, "edges" : edge_data_set }
				network = new vis.Network(container, network_data, options)

				network.on("oncontext", UI.networkRightClick)
				network.on("doubleClick", function(e){
					// Renameing nodes and edges:
					if (_.size(e.nodes) == 1) {
						var newName = prompt("New node name:")
						var isUnused = _.find(node_data_set.get(), (n) => n.label == newName) === undefined
						if (newName !== null && isUnused) {
							UI.renameNode(e.nodes[0], newName)
						} else {
							if (! isUnused) { alert("That name is already used.") }
						}
					} 
					// else { if (_.size(e.edges) == 1) {
					// 	var newName = prompt("New edge name:")
					// 	if (newName !== null) {
					// 		UI.renameEdge(e.edges[0], newName)
					// 	}
					// }}
				})
				// network.on("oncontext", function(){})
				network.on("selectNode", function(data){
					if (data.nodes.length == 1) {
						UI.render.localVars(data.nodes[0])
					}
				})
				network.on("deselectNode", function(data){
					UI.render.localVars(null)
				})
				// network.on("selectEdge", function(data){console.log("selectEdge"); console.log(data)})
				// network.on("deselectEdge", function(data){console.log("deselectEdge"); console.log(data)})
				network.on("hold", function(e){
					console.log(e)
				})
				network.on("dragStart", function(e){
					var selectedNodes = network.getSelectedNodes()
					if ( ! _.isEmpty(selectedNodes)) {
						UI.movingNodes = network.getPositions(selectedNodes)
					}
				})
				network.on("dragEnd", function(e){
					if (UI.movingNodes != null) {
						var from = UI.movingNodes
						var to = network.getPositions(_.keys(UI.movingNodes))
						UI.movingNodes = null
						journal.past.push({ "type" : "move", "from": from, "to": to })
					}
				})
				// $("#graph").on("mousemove", null)	// Cannot use network 'dragging' event?
			}
		},

		clearNetwork : function() {
			if (_.isEmpty(node_data_set.get()) || confirm("Changing palettes will clear the drawing canvas.")) {
				journal.past = []
				journal.applyEventEffects( { type: "subtract", nodes: node_data_set.get(), edges: edge_data_set.get() } )
				return true
			} else { return false }
		},

		choosePalette: function(elem) {
			chosenPalette = $(elem).val()
			if (UI.clearNetwork()) {
				UI.render.palette(availablePalettes[chosenPalette])
			}
		},

		makeNode : function(node, className) {
			if ( ! node.hasOwnProperty("id")) { 
				function randomUuid() {
					return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
						var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8)
						return v.toString(16)
					})
				}
				node.id = randomUuid()
			}
			node.props = _.clone(availablePalettes[chosenPalette][className])
			node.image = node.props.icon
			return node
		},

		// This is a terrible hack!
		propBlur: function(idObj, key, val){
			UI.setProp(idObj.id, key, val)
		},

		updateRewardVar : function(rvKey) {
			parent = $(".rv_element[rv_key='"+rvKey+"']")
			var new_rv = {
				key: parent.find(".key").html(),
				opt1: parent.find(".opt1").val(),
				opt2: parent.find(".opt2").val(),
				range: {
					start: parent.find(".range_start").val(),
					end: parent.find(".range_end").val(),
					step: parent.find(".range_step").val()
				}
			}
			var old_rv = _.clone(_.find(reward_vars, (v) => v.key == new_rv.key))
			var event = { type: "setRewardVar", key: new_rv.key, old: old_rv, new: new_rv }
			journal.apply( event )
		},

		addRewardVar : function() {
			var name = prompt("Name your new reward variable:")
			if (name != undefined && ! _.contains(_.pluck(reward_vars, "id"), name )) {
				var new_rv = { 
					key: name, 
					opt1: getOrElse(_.find(node_data_set.get(), (n) => n.props.type == "noun"), {label: ""}).label,
					opt2: "Instant of Time", 
					range: { start: 0, end: 100, step: 5 }
				}
				var event = { type: "setRewardVar", key: new_rv.key, old: null, new: new_rv }
				journal.apply(event)
			}
		},

		removeRewardVar : function(key) {
			if (key != undefined && ! _.contains(_.pluck(reward_vars, "id"), key )) {
				var old_rv = _.find(reward_vars, (v) => v.key == key)
				var event = { type: "setRewardVar", key: key, old: old_rv, new: null }
				journal.apply(event)
			}
		},

		addGlobalVar : function() {
			alert("Not supported yet.")
		},

		addLocalVar : function() {
			alert("Not supported yet.")
		},

		setProp: function(id, key, value) {
			var paramList = get(node_data_set.get(id), ['props', 'parameters'])
			var previous = get(_.find(paramList, (p) => p.name === key), ['value'])
			journal.apply(
				{ type: "setProp", id: id, key: key, previous: previous, updated: value }
			)
		},

		renameEdge : function(edgeId, newName) {
			var existing = edge_data_set.get(edgeId)
			var event = {type: "renameEdge", id: edgeId, from: existing.label, to: newName}
			journal.apply(event)
		},

		renameNode : function(nodeId, newName) {
			var existing = node_data_set.get(nodeId)
			var event = {type: "renameNode", id: nodeId, from: existing.label, to: newName}
			journal.apply(event)
		},
		
		updateButtonStates : function() {
			if (_.isEmpty(journal.past)) {
				$("#undo_button").addClass("disabled")
			} else {
				$("#undo_button").removeClass("disabled")
			}
			if (_.isEmpty(journal.future)) {
				$("#redo_button").addClass("disabled")
			} else {
				$("#redo_button").removeClass("disabled")
			}
			var selectedNodes = network.getSelectedNodes()
			if (selectedNodes.length == 1) {
				UI.render.localVars(selectedNodes[0])
			} else {
				UI.render.localVars(null)
			}
			UI.render.rewardVars()
		},

		selectPaletteNode : function(elem) {
			$("#palette img").removeClass("selected")
			$(elem).addClass("selected")
		},

		networkRightClick : function(context) {
			context.event.preventDefault()
		},

		movingNodes : null, // or:	{ nodeId1: {x: xValue, y: yValue}, ‚Ä¶ }

		download : function() {
			var data = {
				journal: journal.past,
				reward_vars: reward_vars,
				global_vars: global_vars,
			}
			var blob = new Blob([JSON.stringify(data)], {type: "application/json"})
			var a = document.createElement('a')
			a.download = "model.json"
			a.href = URL.createObjectURL(blob)
			a.target = "_blank"
			a.click()
		},

		upload : function(event) {
			var files = event.target.files
			_.map(files, function(f){
				if (f.type === "application/json") {
					journal.future = []
					UI.clearNetwork()
					var reader = new FileReader()
					reader.onload = function(e) {
						var data = JSON.parse(e.target.result)
						journal.future = journal.future.concat(data.journal)
						global_vars = data.global_vars
						reward_vars = data.reward_vars
						UI.updateButtonStates()
					}
					reader.onloadend = function(e) {
						do { $("#redo_button").click() }
						while ( ! $("#redo_button").hasClass("disabled"))
						UI.render.rewardVars()
						UI.render.localVars()
					}
					reader.readAsText(f)
				}
			})
		}
	}


	var IR = {

		chartCount: 0,
		chartDataAcc: [],

		submit : function(){
			if (_.isEmpty(reward_vars) || !_.isEmpty(_.find(reward_vars, (rv) => rv.opt1 == ""))) { return alert("Cannot execute a model with no reward variables. Please create at least one reward variable.")}

			$.fancybox.open($("<img>").attr({src: "images/spinner.gif"}))
			
			IR.submitGraph(function(data, status, jqXHR) {
				IR.chartCount = reward_vars.length
				IR.chartDataAcc = []

				_.map(reward_vars, function(rv) {
					var simParams = {
						"initialTime": parseFloat(rv.range.start),
						"finalTime": parseFloat(rv.range.end),
						"stepSize": parseFloat(rv.range.step),
						"savePlot": null
					}
					if (_.range(simParams.initialTime, simParams.finalTime, simParams.stepSize).length > 10000) {
						alert("Sampling the range you defined will require more memory than this system can spare right now.")
						$.fancybox.destroy()
						return false
					}
					IR.execute.backend.integrate(simParams, function(data, status, jqXHR) {
						IR.chartDataAcc.push({
							title: rv.opt1,
							labels: data.times,
							series: [
								data.variables[rv.opt1]
							]
						})
						if (IR.chartCount == IR.chartDataAcc.length){
							UI.render.fancyCharts( IR.chartDataAcc )
							IR.chartDataAcc = []
							IR.chartCount = 0
						}
					})
				})
			})
		},

		submitGraph : function(onSuccessFunc){
			$.post("/appstate/uiModel", IR.getData(), onSuccessFunc)
		},

		execute : {
			backend : {
				integrate : function(simParams, onSuccessFunc) {
					$.postJSON("/backends/"+chosen_backend+"/integrate", simParams, onSuccessFunc)
				}
			}
		},

		getData : function(){
			return {
				graph: JSON.stringify({
					nodes : node_data_set.getDataSet()._data,
					links : edge_data_set.getDataSet()._data
				}),
				globalVariables: JSON.stringify(global_vars)
			}
		}
	}


	var chosenPalette = "SIR"
	var availablePalettes = {
		"SIR" : {
			"population": {
				"className": "population",
				"type": "noun",
				"classDef": "population.air",
				"icon": "images/person.svg",
				"parameters": [{"name": "Initial", "value": "250"}]
			}, 
			"patient" : {
				"className": "patient",
				"type": "noun",
				"classDef": "patient.air",
				"icon": "images/patient.svg",
				"parameters": [{"name": "Initial", "value": "250"}]
			}, 
			"infect": {
				"className": "infect",
				"type": "verb",
				"classDef": "infect.air",
				"icon": "images/virus.svg",
				"verb_sort": {
					"type": "conserved",
					"rate_template": "beta * INPUT * OUTPUT / total_pop"
				},
				"parameters": [
					{"name": "beta", "value": "0.413"},
					{"name": "total_pop", "value": "Susceptible + Infected + Recovered"}
				]
			},
			"cure": {
				"className": "cure",
				"type": "verb",
				"classDef": "cure.air",
				"icon": "images/cure.svg",
				"verb_sort": {
					"type": "conserved",
					"rate_template": "gamma * INPUT"
				},
				"parameters": [{"name": "gamma", "value": "0.333"}]
			}
		},
		"SIRS-VD": {
			"population": {
				"className": "population",
				"type": "noun",
				"classDef": "population.air",
				"icon": "images/person.svg",
				"parameters": [{"name": "Initial", "value": "250"}]
			}, 
			"patient" : {
				"className": "patient",
				"type": "noun",
				"classDef": "patient.air",
				"icon": "images/patient.svg",
				"parameters": [{"name": "Initial", "value": "250"}]
			}, 
			"infect": {
				"className": "infect",
				"type": "verb",
				"classDef": "infect.air",
				"icon": "images/virus.svg",
				"verb_sort": {
					"type": "conserved",
					"rate_template": "beta * INPUT * OUTPUT / total_pop"
				},
				"parameters": [
					{"name": "beta", "value": "0.413"},
					{"name": "total_pop", "value": "Susceptible + Infected + Recovered"}
				]
			},
			"cure": {
				"className": "cure",
				"type": "verb",
				"classDef": "cure.air",
				"icon": "images/cure.svg",
				"verb_sort": {
					"type": "conserved",
					"rate_template": "gamma * INPUT"
				},
				"parameters": [{"name": "gamma", "value": "0.333"}]
			},
			"birth": {
				"className": "birth",
				"type": "verb",
				"classDef": "birth.air",
				"icon": "images/birth.svg",
				"verb_sort": {
					"type": "source",
					"rate_in_template": "mu * OUTPUT"
				},
				"parameters": [
					{"name": "mu", "value": "0.00007"}
				]
			},
			"death": {
				"className": "death",
				"type": "verb",
				"classDef": "death.air",
				"icon": "images/death.svg",
				"verb_sort": {
					"type": "sink",
					"rate_out_template": "nu * INPUT"
				},
				"parameters": [
					{"name": "nu", "value": "0.00002"}
				]
			},
      "time": {
        "className": "time",
				"type": "verb",
				"classDef": "time.air",
				"icon": "images/time.svg",
				"verb_sort": {
					"type": "conserved",
					"rate_template": "eta * INPUT"
				},
				"parameters": [
					{"name": "eta", "value": "0.002"}
				]

      }
		},
		"predator_prey" : {
			"predator": {
				"className": "predator",
				"type": "noun",
				"classDef": "predator.air",
				"icon": "images/predator.svg",
				"parameters": [{"name": "Initial", "value": "0.9"}]
			}, 
			"prey" : {
				"className": "prey",
				"type": "noun",
				"classDef": "prey.air",
				"icon": "images/prey.svg",
				"parameters": [{"name": "Initial", "value": "0.9"}]
			}, 
			"hunting": {
				"className": "hunting",
				"type": "verb",
				"classDef": "hunting.air",
				"icon": "images/hunting.svg",
				"verb_sort": {
					"type": "unconserved",
					"rate_in_template": "beta * INPUT * OUTPUT",
					"rate_out_template": "delta * INPUT * OUTPUT"
				},
				"parameters": [
					{"name": "beta", "value": "1.33"},
					{"name": "delta", "value": "1"}
				]
			},
			"breeding": {
				"className": "breeding",
				"type": "verb",
				"classDef": "breeding.air",
				"icon": "images/breeding.svg",
				"verb_sort": {
					"type": "source",
					"rate_in_template": "alpha * OUTPUT"
				},
				"parameters": [{"name": "alpha", "value": "0.66"}]
			},
			"death": {
				"className": "death",
				"type": "verb",
				"classDef": "death.air",
				"icon": "images/death.svg",
				"verb_sort": {
					"type": "sink",
					"rate_out_template": "gamma * INPUT"
				},
				"parameters": [
					{"name": "gamma", "value": "1"}
				]
			}
		}
	}



	$(function(){
		document.getElementById('choose-upload').addEventListener('change', UI.upload, false)

		var startingPalette = availablePalettes[chosenPalette]
		$("#paletteChooser select").append(_.map(_.keys(availablePalettes), (k) => $("<option>").html(k)))

		UI.render.network()

		var sample_nodes = [
			UI.makeNode({id: "1", label: "Susceptible", x: -350, y: 0}, "population"), 
			UI.makeNode({id: "2", label: "Exposed", x: -175, y: 0}, "infect"),
			UI.makeNode({id: "3", label: "Infected", x: -0, y: 0}, "patient"),
			UI.makeNode({id: "4", label: "Cured", x: 175, y: 0}, "cure"),
			UI.makeNode({id: "5", label: "Recovered", x: 350, y: 0}, "population")
		]
		var sample_edges = [
			{id: "a", from: "1", to: "2"},
			{id: "b", from: "2", to: "3"},
			{id: "c", from: "3", to: "4"},
			{id: "d", from: "4", to: "5"},
		]
		/*
		var sample_nodes = [
			UI.makeNode({id: "1", label: "Breeding", x: -175, y: -175}, "breeding"), 
			UI.makeNode({id: "2", label: "Prey", x: -175, y: 0}, "prey"),
			UI.makeNode({id: "3", label: "Hunting", x: -0, y: 0}, "hunting"),
			UI.makeNode({id: "4", label: "Predator", x: 175, y: 0}, "predator"),
			UI.makeNode({id: "5", label: "Death", x: 175, y: 175}, "death")
		]
		var sample_edges = [
			{id: "a", from: "1", to: "2"},
			{id: "b", from: "2", to: "3"},
			{id: "c", from: "3", to: "4"},
			{id: "d", from: "4", to: "5"},
		]
		*/

		// journal.apply( { "type": "add", "nodes": sample_nodes, "edges": sample_edges } )


		UI.render.palette(startingPalette)
		UI.render.localVars(null)
		UI.render.rewardVars()
		UI.updateButtonStates()
	})

</script>

<style type="text/css">
	html, body, #graph {
		padding: 0px;
		margin: 0px;
		height: 100%;
		width: 100%;
		overflow: hidden;
	}
	#header {
		text-align: center;
	}
	#graph {
		float:left;
		width: 75%;
		/*border: 5px solid gray;*/
	}
	#palette img {
		margin: 5px;
		padding: 5px;
		height: 50px;
		border: 5px solid white;
	}
	.vis-manipulation {
		outline: 1px solid gray;
		width: 99.9% !important; /* Ugly UI hack! */
	}
	.vis-close {
		display: none !important;
	}
	.verb {
		fill: gray;
	}
	#palette img.selected {
		border-color: lightblue;
	}
	#palette img.right {
		margin-top: 1em;
		height: 25px;
	}
	#palette .right{
		float: right;
	}
	#exec_button {
		margin: 22px 0px 22px 22px;
	}
	#exec_chooser {
		margin: 22px 0px 22px 0px;
	}
	#paletteChooser{
		margin: 1.5em 1.5em 0em 1.5em;
		float: left;
	}
	#palette img.disabled {
		opacity: 0.25;
	}
	#variables {
		height: 100%;
		width: 25%;
		border-color: green;
		float: right;
	}
	#localVars {
		width: 100%;
		height: 45%;
		outline: 1px solid gray;
		overflow: scroll;
		padding: 1em;
		box-sizing: border-box;
	}
	#localVars p {
		/*text-decoration: underline;*/
	}
	#rewardVars {
		width: 100%;
		height: 45%;
		outline: 1px solid gray;
		overflow: scroll;
		padding: 1em;
		box-sizing: border-box;
	}
	#rewardVars .rv_element:not(:last-child) {
		border-bottom: 1px solid #000;
		margin-bottom: 1em;
	}
	.range_param {
		display: inline-block;
		padding: 1em;
	}
	.opt2 {
		margin: 0px;
	}
	h2 {
		font-size: 1.75em;
	}
	h3 {
		font-size: 1.5em;
	}
	h4 {
		font-size: 1.1em;
	}
	.resultChart {
		width: 80%;
		height: 80%
	}

</style></head>
<body>
	<div id="results" style="display: none;"></div>
	<div id="palette">
		<div id="paletteChooser">
			<select onchange="UI.choosePalette(this)"></select>
		</div>
		<select id="exec_chooser" class="right" onchange="UI.changeBackend(this)">
			<option value="scipy">SciPy</option>
			<option value="pysces">PySCeS</option>
		</select>
		<button id="exec_button" class="right" onclick="IR.submit()">Execute</button>
		<img id="redo_button" class="right" src="images/redo.png" onclick="journal.redo()" />
		<img id="undo_button" class="right" src="images/undo.png" onclick="journal.undo()" />
		<img id="upload" class="right" src="images/upload.png" onclick="document.getElementById('choose-upload').click()" />
		<img id="download" class="right" src="images/download.png" onclick="UI.download()" />
		<input type="file" id="choose-upload" name="files[]" style="display: none;" multiple />
	</div>
	<div id="graph"></div>
	<div id="variables" class="compensate-for-scrollbar">
		<div id="localVars" class="compensate-for-scrollbar"></div>
		<div id="rewardVars" class="compensate-for-scrollbar"></div>
	</div>
</body>
